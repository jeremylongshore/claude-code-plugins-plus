---
name: {{ company }}-webhooks-events
description: |
  {{ display_name }} webhook signature validation and event handling.
  Use when implementing webhook endpoints or processing {{ display_name }} events.
  Trigger with phrases like "{{ company }} webhook", "{{ company }} events",
  "{{ company }} webhook signature", "handle {{ company }} events".
allowed-tools: Read, Write, Edit, Bash({{ company }}:*)
version: 1.0.0
license: MIT
author: Jeremy Longshore <jeremy@intentsolutions.io>
---

# {{ display_name }} Webhooks & Events

## Overview
Securely handle {{ display_name }} webhooks with signature validation and replay protection.

## Prerequisites
- {{ company }}-install-auth completed
- Web server running (Express, Fastify, etc.)
- {{ display_name }} webhook secret from dashboard
- HTTPS endpoint for production

## Instructions

### Step 1: Webhook Endpoint Setup

### Express.js
```typescript
import express from 'express';
import crypto from 'crypto';

const app = express();

// IMPORTANT: Raw body needed for signature verification
app.post('/webhooks/{{ company }}',
  express.raw({ type: 'application/json' }),
  async (req, res) => {
    const signature = req.headers['{{ signature_header | default('x-' + company + '-signature') }}'] as string;
    const timestamp = req.headers['{{ timestamp_header | default('x-' + company + '-timestamp') }}'] as string;

    if (!verify{{ display_name }}Signature(req.body, signature, timestamp)) {
      return res.status(401).json({ error: 'Invalid signature' });
    }

    const event = JSON.parse(req.body.toString());
    await handle{{ display_name }}Event(event);

    res.status(200).json({ received: true });
  }
);
```

## Signature Verification

```typescript
function verify{{ display_name }}Signature(
  payload: Buffer,
  signature: string,
  timestamp: string
): boolean {
  const secret = process.env.{{ company | upper }}_WEBHOOK_SECRET!;

  // Reject old timestamps (replay attack protection)
  const timestampAge = Date.now() - parseInt(timestamp) * 1000;
  if (timestampAge > 300000) { // 5 minutes
    console.error('Webhook timestamp too old');
    return false;
  }

  // Compute expected signature
  const signedPayload = `${timestamp}.${payload.toString()}`;
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(signedPayload)
    .digest('hex');

  // Timing-safe comparison
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expectedSignature)
  );
}
```

## Event Handler Pattern

```typescript
type {{ display_name }}EventType = {{ event_types | default("'resource.created' | 'resource.updated' | 'resource.deleted'") }};

interface {{ display_name }}Event {
  id: string;
  type: {{ display_name }}EventType;
  data: Record<string, any>;
  created: string;
}

const eventHandlers: Record<{{ display_name }}EventType, (data: any) => Promise<void>> = {
  {{ event_handlers | default("'resource.created': async (data) => { /* handle */ },\n  'resource.updated': async (data) => { /* handle */ },\n  'resource.deleted': async (data) => { /* handle */ }") }}
};

async function handle{{ display_name }}Event(event: {{ display_name }}Event): Promise<void> {
  const handler = eventHandlers[event.type];

  if (!handler) {
    console.log(`Unhandled event type: ${event.type}`);
    return;
  }

  try {
    await handler(event.data);
    console.log(`Processed ${event.type}: ${event.id}`);
  } catch (error) {
    console.error(`Failed to process ${event.type}: ${event.id}`, error);
    throw error; // Rethrow to trigger retry
  }
}
```

## Idempotency Handling

```typescript
import { Redis } from 'ioredis';

const redis = new Redis(process.env.REDIS_URL);

async function isEventProcessed(eventId: string): Promise<boolean> {
  const key = `{{ company }}:event:${eventId}`;
  const exists = await redis.exists(key);
  return exists === 1;
}

async function markEventProcessed(eventId: string): Promise<void> {
  const key = `{{ company }}:event:${eventId}`;
  await redis.set(key, '1', 'EX', 86400 * 7); // 7 days TTL
}
```

### Step 2: Webhook Testing

```bash
# Use {{ display_name }} CLI to send test events
{{ cli_webhook_test | default(company + ' webhooks trigger resource.created --url http://localhost:3000/webhooks/' + company) }}

# Or use webhook.site for debugging
curl -X POST https://webhook.site/your-uuid \
  -H "Content-Type: application/json" \
  -d '{"type": "resource.created", "data": {}}'
```

## Output
- Webhook endpoint responding with 200 on valid signatures
- Events processed and logged
- Idempotency preventing duplicate processing
- Replay attacks rejected (timestamp validation)

## Error Handling

| Error | Cause | Solution |
|-------|-------|----------|
| Invalid signature (401) | Wrong secret or payload tampering | Verify webhook secret matches dashboard |
| Timestamp too old | Replay attack or clock drift | Check server time sync, reject old events |
| Duplicate event | Event processed twice | Implement idempotency with Redis/DB |
| Handler timeout | Slow event processing | Use async queue for heavy processing |

## Examples

### Next.js API Route
```typescript
export async function POST(req: Request) {
  const body = await req.text();
  const signature = req.headers.get('{{ signature_header | default('x-' + company + '-signature') }}');

  if (!verifySignature(body, signature)) {
    return Response.json({ error: 'Invalid signature' }, { status: 401 });
  }

  const event = JSON.parse(body);
  await processEvent(event);

  return Response.json({ received: true });
}
```

## Resources
- [{{ display_name }} Webhooks Guide]({{ docs_url | default('https://docs.' + company + '.com') }}/webhooks)
- [Webhook Security Best Practices]({{ docs_url | default('https://docs.' + company + '.com') }}/webhooks/security)
- [Event Types Reference]({{ docs_url | default('https://docs.' + company + '.com') }}/webhooks/events)

## Next Steps
For performance optimization, see `{{ company }}-performance-tuning`.
